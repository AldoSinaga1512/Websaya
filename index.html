<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Menu Pasta</title>
  <meta name="description" content="Menu Pasta dengan keranjang belanja, checkout WhatsApp, pratinjau struk, testimoni, dan pencarian.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --radius: 1rem; }
    html, body { font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .sidebar-cart { transition: transform 0.3s ease-in-out; }
    .sidebar-cart.closed { transform: translateX(100%); }

    /* Left slide menu */
    .left-menu { transition: transform 0.28s ease-in-out; transform: translateX(-100%); }
    .left-menu.open { transform: translateX(0); }

    /* Toast animation */
    .toast { animation: slideIn 0.4s, fadeOut 0.4s 2.6s forwards; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { to { opacity: 0; transform: translateX(100%); } }

    /* Simple star rating display */
    .star { filter: grayscale(100%); opacity: 0.4; }
    .star.active { filter: none; opacity: 1; }

    @media (max-width: 640px) { #cart { width: 100%; } }
    .btn { border-radius: var(--radius); }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <!-- Header -->
  <header class="bg-green-600 text-white p-4 flex items-center justify-between gap-3 sticky top-0 z-50">
    <div class="flex items-center gap-3">
      <button id="hamburger" onclick="openLeftMenu()" 
        class="p-2 rounded-md bg-green-700/80 hover:bg-green-700" aria-label="Buka menu">‚ò∞</button>
      <h1 class="text-2xl font-bold">Menu Pasta</h1>
    </div>

    <div class="flex items-center gap-2 w-full sm:w-auto">
      <!-- Search -->
      <div class="flex-1 sm:w-80 relative">
        <input id="search" type="text" placeholder="Cari menu‚Ä¶" 
          class="w-full pl-10 pr-3 py-2 rounded-lg text-gray-900 placeholder:text-gray-200/80 focus:outline-none focus:ring-2 focus:ring-white/60" 
          aria-label="Cari menu"/>
        <span class="absolute left-3 top-1/2 -translate-y-1/2" aria-hidden="true">üîé</span>
      </div>
      <!-- Cart Button -->
      <button onclick="toggleCart()" class="relative ml-2 shrink-0" aria-label="Buka keranjang">
        üõí
        <span class="absolute -top-2 -right-2 bg-red-600 text-white text-xs px-1 rounded-full" id="cart-count">0</span>
      </button>
    </div>
  </header>

  <!-- Sidebar Menu (Kiri) -->
  <aside id="left-menu" class="left-menu fixed top-0 left-0 w-72 h-full bg-white shadow-lg z-50 p-6 overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-lg font-bold">Menu</h2>
      <button onclick="closeLeftMenu()" class="text-red-500 text-xl font-bold">√ó</button>
    </div>
    <nav class="space-y-4">
      <div>
        <h3 class="font-semibold text-gray-700">üìû Kontak Person</h3>
        <p><a href="https://wa.me/6281388728037" target="_blank" class="text-green-600 underline">+62 813-8872-8037</a></p>
      </div>
      <div>
        <h3 class="font-semibold text-gray-700">üïí Jam Operasional</h3>
        <p>Senin - Minggu<br>10.00 - 22.00 WIB</p>
      </div>
      <div>
        <h3 class="font-semibold text-gray-700">üìç Alamat</h3>
        <p>Jl. Raya Pasta No. 15, Jakarta</p>
      </div>
      <div>
        <h3 class="font-semibold text-gray-700">üìë Syarat & Ketentuan</h3>
        <ul class="list-disc list-inside text-sm text-gray-600">
          <li>Pemesanan hanya melalui WhatsApp.</li>
          <li>Harga belum termasuk ongkir.</li>
          <li>Pesanan diproses setelah pembayaran.</li>
        </ul>
      </div>
    </nav>
  </aside>

  <!-- Category Tabs -->
  <nav class="bg-white border-b sticky top-[64px] z-30">
    <div class="max-w-6xl mx-auto px-4 py-2 flex flex-wrap gap-2">
      <button class="tab active bg-green-600 text-white px-3 py-1 rounded-full" data-cat="all">Semua</button>
      <button class="tab bg-gray-100 px-3 py-1 rounded-full" data-cat="Pasta">Pasta</button>
      <button class="tab bg-gray-100 px-3 py-1 rounded-full" data-cat="Minuman">Minuman</button>
      <button class="tab bg-gray-100 px-3 py-1 rounded-full" data-cat="Dessert">Dessert</button>
    </div>
  </nav>

  <!-- Overlay for cart & left menu clicks -->
  <div id="overlay" class="hidden fixed inset-0 bg-black/50 z-40" onclick="closeAllOverlays()"></div>

  <!-- Sidebar Cart -->
  <aside id="cart" class="sidebar-cart closed fixed top-0 right-0 w-96 h-full bg-white shadow-lg z-50 p-4 overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-bold">Keranjang Belanja</h2>
      <button onclick="toggleCart()" class="text-red-500 text-2xl font-bold leading-none" aria-label="Tutup keranjang">√ó</button>
    </div>
    <ul id="cart-items" class="space-y-2"></ul>
    <div class="mt-4 border-t pt-4 space-y-2">
      <div class="flex justify-between text-sm"><span>Subtotal</span><span id="cart-subtotal">Rp 0</span></div>
      <div class="flex items-center justify-between text-sm">
        <label class="mr-2" for="shipping">Ongkir (opsional)</label>
        <input id="shipping" type="number" min="0" placeholder="0" class="w-32 p-1 border rounded text-right" oninput="updateCartTotal()"/>
      </div>
      <div class="flex justify-between font-bold text-base border-t pt-2"><span>Total</span><span id="cart-total">Rp 0</span></div>
      <button onclick="openReceiptPreview()" class="w-full mt-2 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Lihat Struk & Checkout</button>
    </div>
  </aside>

  <!-- Confirm-before-checkout Modal -->
  <div id="confirm-checkout-modal" class="hidden fixed inset-0 bg-black/60 z-[75] flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-4 max-w-md w-full">
      <h3 class="font-bold text-lg mb-2">Konfirmasi Ketersediaan</h3>
      <p class="text-sm text-gray-700 mb-4">Apakah Anda sudah menanyakan ketersediaan menu ke admin? Jika belum, silakan tanyakan dulu agar pesanan tidak dibatalkan.</p>
      <div class="flex gap-2">
        <button id="confirm-yes" class="flex-1 bg-green-600 text-white py-2 rounded">Ya, sudah</button>
        <button id="confirm-no" class="flex-1 bg-gray-200 py-2 rounded">Belum</button>
      </div>
    </div>
  </div>

  <!-- Receipt Preview Modal -->
  <div id="receipt-modal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-xl shadow-lg overflow-hidden">
      <div class="p-4 border-b flex justify-between items-center">
        <h3 class="font-bold">Pratinjau Struk</h3>
        <button onclick="closeReceiptPreview()" class="text-xl" aria-label="Tutup">√ó</button>
      </div>
      <div id="receipt-content" class="p-4 text-sm">
        <!-- Filled by JS -->
      </div>
      <div class="p-4 border-t flex gap-2">
        <button onclick="printReceipt()" class="flex-1 bg-gray-200 rounded-lg py-2">Cetak Struk</button>
        <button onclick="showCheckoutForm()" class="flex-1 bg-green-600 text-white rounded-lg py-2">Lanjut ke Checkout</button>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="image-modal" class="hidden fixed inset-0 bg-black/70 z-[55] items-center justify-center p-4">
    <div class="relative bg-white rounded-xl overflow-hidden max-w-2xl w-full">
      <button onclick="closeImageModal()" class="absolute right-2 top-2 bg-black/70 text-white rounded-full w-8 h-8 flex items-center justify-center" aria-label="Tutup gambar">√ó</button>
      <img id="image-modal-src" src="" alt="Preview" class="w-full object-contain max-h-[80vh] bg-black"/>
    </div>
  </div>

  <!-- Checkout Form -->
  <div id="checkout-form" class="hidden fixed top-0 left-0 w-full h-full bg-gray-800 bg-opacity-50 flex justify-center items-center z-[70] p-4">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Isi Form Checkout</h2>
      <form id="form-checkout" onsubmit="submitCheckout(event)" class="space-y-3">
        <div>
          <label for="name" class="block mb-1">Nama Lengkap</label>
          <input type="text" id="name" placeholder="Contoh: Aldo Sinaga" class="w-full p-2 border rounded" required />
        </div>
        <div>
          <label for="whatsapp" class="block mb-1">Nomor WhatsApp</label>
          <input type="text" id="whatsapp" placeholder="Contoh: 08123456789" class="w-full p-2 border rounded" required />
        </div>
        <div>
          <label for="address" class="block mb-1">Alamat Pengiriman</label>
          <textarea id="address" placeholder="Tulis alamat lengkap‚Ä¶" class="w-full p-2 border rounded" required></textarea>
        </div>
        <div>
          <label for="payment" class="block mb-1">Metode Pembayaran</label>
          <select id="payment" class="w-full p-2 border rounded">
            <option>COD (Bayar di tempat)</option>
            <option>Transfer Bank</option>
            <option>QRIS</option>
          </select>
        </div>
        <div>
          <label for="note" class="block mb-1">Catatan Pesanan (opsional)</label>
          <input id="note" class="w-full p-2 border rounded" placeholder="Tanpa keju, level pedas 2, dsb."/>
        </div>
        <div class="flex justify-between space-x-2 pt-2">
          <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Kirim & Checkout</button>
          <button type="button" onclick="closeCheckoutForm()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700">Batal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Produk Grid -->
  <main class="flex-1 max-w-6xl mx-auto p-4">
    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>

    <!-- Cara Pesan Section -->
    <section id="cara-pesan" class="mt-12 bg-white p-4 rounded-lg shadow">
      <h2 class="text-xl font-bold mb-3">Cara Pesan</h2>
      <ol class="list-decimal list-inside text-sm text-gray-700">
        <li>Pilih menu yang diinginkan dan tambahkan ke keranjang.</li>
        <li>Periksa keranjang dan masukkan ongkir jika perlu.</li>
        <li>Klik <strong>Lihat Struk & Checkout</strong> lalu <strong>Lanjut ke Checkout</strong>.</li>
        <li>Sebelum dikirim ke WhatsApp, kamu akan diminta konfirmasi apakah sudah menanyakan ketersediaan menu ke admin. <a href="https://wa.me/6281388728037?text=Halo%20Admin,%20apakah%20menu%20tersedia%20hari%20ini?" 
   target="_blank" 
   class="block bg-green-600 text-white text-center py-2 rounded hover:bg-green-700 mt-2">
   Tanya Ketersediaan via WhatsApp
</a>

        <li>Jika sudah, pilih "Ya, sudah" untuk melanjutkan pengiriman pesanan ke WhatsApp.</li>
      </ol>
    </section>
     
    <!-- Testimoni Section -->
    <section id="testimoni" class="mt-8">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-bold">Testimoni Pelanggan</h2>
        <button onclick="openTestiModal()" class="text-sm bg-blue-600 text-white px-3 py-1 rounded">Tulis Testimoni</button>
      </div>
      <div id="testi-list" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
    </section>
  </main>

  <!-- Testimoni Modal -->
  <div id="testi-modal" class="hidden fixed inset-0 bg-black/50 z-[65] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-xl shadow-lg overflow-hidden">
      <div class="p-4 border-b flex justify-between items-center">
        <h3 class="font-bold">Tulis Testimoni</h3>
        <button onclick="closeTestiModal()" class="text-xl" aria-label="Tutup">√ó</button>
      </div>
      <form onsubmit="saveTesti(event)" class="p-4 space-y-3">
        <div>
          <label class="block mb-1">Nama</label>
          <input id="testi-name" class="w-full p-2 border rounded" placeholder="Nama kamu" required>
        </div>
        <div>
          <label class="block mb-1">Rating</label>
          <select id="testi-rating" class="w-full p-2 border rounded">
            <option value="5">5 - Mantap!</option>
            <option value="4">4 - Enak</option>
            <option value="3">3 - Cukup</option>
            <option value="2">2 - Kurang</option>
            <option value="1">1 - Tidak suka</option>
          </select>
        </div>
        <div>
          <label class="block mb-1">Komentar</label>
          <textarea id="testi-text" class="w-full p-2 border rounded" placeholder="Tulis pengalamanmu‚Ä¶" required></textarea>
        </div>
        <div class="flex gap-2">
          <button class="flex-1 bg-blue-600 text-white py-2 rounded">Simpan</button>
          <button type="button" onclick="closeTestiModal()" class="flex-1 bg-gray-200 py-2 rounded">Batal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-[100]"></div>

  <!-- Footer -->
  <footer id="footer" class="bg-gray-900 text-white p-6 mt-10">
    <div class="max-w-6xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-3">
      <p class="text-center sm:text-left">¬© <span id="year"></span> Menu Pasta | All rights reserved.</p>
      <div class="flex gap-4">
        <a href="https://www.instagram.com/aldosinaga15/" target="_blank" aria-label="Instagram"><img src="instagram.png" alt="Instagram" class="w-7 h-7"></a>
        <a href="https://www.tiktok.com/@cacing.besar.alaskaaaa" target="_blank" aria-label="TikTok"><img src="social-media.png" alt="TikTok" class="w-7 h-7"></a>
        <a href="https://wa.me/6281388728037" target="_blank" aria-label="WhatsApp"><img src="whatsapp.png" alt="WhatsApp" class="w-7 h-7"></a>
      </div>
    </div>
  </footer>

  <!-- Script -->
  <script>
    // ======= Data Produk (bisa kamu ganti gambar/deskripsi) =======
    const PRODUCTS = [
      { id: 1, name: 'Spaghetti Aglio e Olio', price: 45000, cat: 'Pasta', img: 'pngtree-spaghetti-delicious-delicious-tomato-flavor-photo-png-image_6683220.png', desc: 'Spaghetti bawang putih + minyak zaitun, simple & wangi.' },
      { id: 2, name: 'Spaghetti Bolognese', price: 55000, cat: 'Pasta', img: 'pngtree-spaghetti-delicious-delicious-tomato-flavor-photo-png-image_6683220.png', desc: 'Saus daging sapi tomat khas Italia.' },
      { id: 3, name: 'Spaghetti Carbonara', price: 60000, cat: 'Pasta', img: 'pngtree-spaghetti-delicious-delicious-tomato-flavor-photo-png-image_6683220.png', desc: 'Krim lembut dengan keju parmesan.' },
      { id: 4, name: 'Spaghetti Pesto', price: 52000, cat: 'Pasta', img: 'pngtree-spaghetti-delicious-delicious-tomato-flavor-photo-png-image_6683220.png', desc: 'Basil segar, kacang pinus, parmesan.' },
      { id: 5, name: 'Es Teh Manis', price: 10000, cat: 'Minuman', img: 'https://images.unsplash.com/photo-1511920170033-f8396924c348?q=80&w=1200&auto=format&fit=crop', desc: 'Teh melati segar dengan es.' },
      { id: 6, name: 'Lemon Tea', price: 13000, cat: 'Minuman', img: 'https://images.unsplash.com/photo-1497534446932-c925b458314e?q=80&w=1200&auto=format&fit=crop', desc: 'Teh lemon segar menyegarkan.' },
      { id: 7, name: 'Pudding Cokelat', price: 18000, cat: 'Dessert', img: 'https://images.unsplash.com/photo-1517677208171-0bc6725a3e60?q=80&w=1200&auto=format&fit=crop', desc: 'Puding cokelat lembut dengan vla.' },
      { id: 8, name: 'Cheesecake Slice', price: 25000, cat: 'Dessert', img: 'https://images.unsplash.com/photo-1551024709-8f23befc6cf7?q=80&w=1200&auto=format&fit=crop', desc: 'Cheesecake creamy topping berry.' },
    ];

    // ======= State =======
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let currentCat = 'all';

    // ======= Helpers =======
    function formatRupiah(n) { return n.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' }); }
    function saveCart() { localStorage.setItem('cart', JSON.stringify(cart)); }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast px-4 py-2 rounded shadow text-white ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
      toast.innerText = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ======= Left menu open/close =======
    function openLeftMenu() {
      document.getElementById('left-menu').classList.add('open');
      document.getElementById('overlay').classList.remove('hidden');
    }
    function closeLeftMenu() {
      document.getElementById('left-menu').classList.remove('open');
      document.getElementById('overlay').classList.add('hidden');
    }

    function closeAllOverlays() {
      // close overlay actions
      document.getElementById('overlay').classList.add('hidden');
      document.getElementById('cart').classList.add('closed');
      document.getElementById('left-menu').classList.remove('open');
    }

    // ======= Render Produk =======
    function renderProducts() {
      const grid = document.getElementById('product-grid');
      const q = document.getElementById('search').value.toLowerCase();
      grid.innerHTML = '';
      PRODUCTS
        .filter(p => (currentCat === 'all' || p.cat === currentCat))
        .filter(p => p.name.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q))
        .forEach(p => {
          const card = document.createElement('div');
          card.className = 'bg-white rounded-xl shadow hover:shadow-md transition p-4 flex flex-col';
          card.innerHTML = `
            <img src="${p.img}" alt="${p.name}" class="w-full h-40 object-cover rounded mb-2 cursor-pointer transform hover:scale-105 transition" onclick="openImageModal('${p.img.replace(/'/g, "\\'")}")">
          ` +
            `<h3 class="text-lg font-semibold">${p.name}</h3>` +
            `<p class="text-sm text-gray-600">${p.desc}</p>` +
            `<p class="text-green-600 font-bold mt-1">${formatRupiah(p.price)}</p>` +
            `<div class="mt-auto pt-2">` +
              `<button onclick="addToCart('${p.name.replace(/'/g, "\\'")}', ${p.price})" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+ Keranjang</button>` +
            `</div>`;
          grid.appendChild(card);
        });

      if (!grid.children.length) {
        const empty = document.createElement('div');
        empty.className = 'col-span-full text-center text-gray-500 py-10';
        empty.textContent = 'Tidak ada produk yang cocok.';
        grid.appendChild(empty);
      }
    }

    // ======= Cart =======
    function addToCart(name, price) {
      const existing = cart.find(i => i.name === name);
      if (existing) existing.qty++; else cart.push({ name, price, qty: 1 });
      updateCart(); saveCart(); showToast(`${name} ditambahkan ke keranjang ‚úÖ`);
    }

    function changeQuantity(index, action) {
      if (action === 'increase') cart[index].qty++;
      else if (action === 'decrease') cart[index].qty = Math.max(1, cart[index].qty - 1);
      updateCart(); saveCart();
    }

    function removeFromCart(index) {
      cart.splice(index, 1); updateCart(); saveCart();
    }

    function updateCart() {
      const itemsContainer = document.getElementById('cart-items');
      const subtotalEl = document.getElementById('cart-subtotal');
      const totalEl = document.getElementById('cart-total');
      const countEl = document.getElementById('cart-count');

      let subtotal = 0; itemsContainer.innerHTML = '';
      cart.forEach((item, index) => {
        const line = item.qty * item.price; subtotal += line;
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center';
        li.innerHTML = `
          <span>${item.name} x${item.qty} - ${formatRupiah(line)}</span>
          <div class="flex items-center gap-2">
            <button onclick="changeQuantity(${index}, 'decrease')" class="text-xs text-gray-600 bg-gray-100 w-6 h-6 rounded" aria-label="Kurangi">-</button>
            <button onclick="changeQuantity(${index}, 'increase')" class="text-xs text-gray-600 bg-gray-100 w-6 h-6 rounded" aria-label="Tambah">+</button>
            <button onclick="removeFromCart(${index})" class="text-xs text-red-600">Hapus</button>
          </div>
        `;
        itemsContainer.appendChild(li);
      });

      subtotalEl.textContent = formatRupiah(subtotal);
      const ship = Number(document.getElementById('shipping').value || 0);
      totalEl.textContent = formatRupiah(subtotal + ship);
      countEl.textContent = cart.reduce((s, i) => s + i.qty, 0);

      if (!cart.length) {
        itemsContainer.innerHTML = '<li class="text-sm text-gray-500">Keranjang kosong</li>';
      }
    }

    function updateCartTotal() { updateCart(); }

    function toggleCart() {
      document.getElementById('cart').classList.toggle('closed');
      document.getElementById('overlay').classList.toggle('hidden');
    }

    // ======= Receipt Preview =======
    function openReceiptPreview() {
      if (cart.length === 0) { showToast('Keranjang masih kosong', 'error'); return; }
      const ship = Number(document.getElementById('shipping').value || 0);
      let subtotal = cart.reduce((s, i) => s + i.qty * i.price, 0);
      const total = subtotal + ship;
      const time = new Date();

      const html = `
        <div class="text-center">
          <h4 class="font-bold text-lg">Menu Pasta</h4>
          <p class="text-xs text-gray-500">${time.toLocaleString('id-ID')}</p>
        </div>
        <div class="my-3 border-t pt-2">
          ${cart.map(i => `<div class='flex justify-between'><span>${i.name} x${i.qty}</span><span>${formatRupiah(i.qty * i.price)}</span></div>`).join('')}
        </div>
        <div class="space-y-1">
          <div class="flex justify-between text-sm"><span>Subtotal</span><span>${formatRupiah(subtotal)}</span></div>
          <div class="flex justify-between text-sm"><span>Ongkir</span><span>${formatRupiah(ship)}</span></div>
          <div class="flex justify-between font-bold border-t pt-2"><span>Total</span><span>${formatRupiah(total)}</span></div>
        </div>
      `;
      document.getElementById('receipt-content').innerHTML = html;
      document.getElementById('receipt-modal').classList.remove('hidden');
    }

    function closeReceiptPreview() { document.getElementById('receipt-modal').classList.add('hidden'); }

    function printReceipt() {
      const content = document.getElementById('receipt-content').innerHTML;
      const w = window.open('', '', 'width=360,height=600');
      w.document.write(`<!DOCTYPE html><html><head><title>Struk</title><style>body{font-family:Arial, sans-serif; padding:16px} .line{display:flex; justify-content:space-between}</style></head><body>${content}</body></html>`);
      w.document.close(); w.focus(); w.print(); w.close();
    }

    // ======= Image Modal =======
    function openImageModal(src) {
      document.getElementById('image-modal-src').src = src;
      const modal = document.getElementById('image-modal');
      modal.classList.remove('hidden'); modal.classList.add('flex');
    }
    function closeImageModal() {
      const modal = document.getElementById('image-modal');
      modal.classList.add('hidden'); modal.classList.remove('flex');
      document.getElementById('image-modal-src').src = '';
    }

    // ======= Checkout with confirmation =======
    function showCheckoutForm() {
      document.getElementById('checkout-form').classList.remove('hidden');
    }
    function closeCheckoutForm() { document.getElementById('checkout-form').classList.add('hidden'); }

    function submitCheckout(event) {
      event.preventDefault();
      const name = document.getElementById('name').value.trim();
      const whatsapp = document.getElementById('whatsapp').value.trim();
      const address = document.getElementById('address').value.trim();
      if (!name || !whatsapp || !address) { showToast('Mohon lengkapi data checkout', 'error'); return; }

      // store form data temporarily on window so confirm handler can use it
      window._checkoutData = {
        name, whatsapp, address,
        payment: document.getElementById('payment').value,
        note: document.getElementById('note').value.trim(),
        ship: Number(document.getElementById('shipping').value || 0)
      };

      // open confirmation modal
      document.getElementById('confirm-checkout-modal').classList.remove('hidden');

      // wire buttons (ensure no duplicate handlers)
      const yesBtn = document.getElementById('confirm-yes');
      const noBtn = document.getElementById('confirm-no');

      // remove previous listeners by cloning
      const yesClone = yesBtn.cloneNode(true);
      yesBtn.parentNode.replaceChild(yesClone, yesBtn);
      const noClone = noBtn.cloneNode(true);
      noBtn.parentNode.replaceChild(noClone, noBtn);

      yesClone.addEventListener('click', () => { document.getElementById('confirm-checkout-modal').classList.add('hidden'); proceedToWhatsApp(); });
      noClone.addEventListener('click', () => { document.getElementById('confirm-checkout-modal').classList.add('hidden'); showToast('Silakan tanyakan ketersediaan dulu ya üòä', 'error'); });
    }

    function proceedToWhatsApp() {
      const data = window._checkoutData;
      if (!data) { showToast('Data checkout tidak ditemukan', 'error'); return; }

      // normalize WA
      let wa = data.whatsapp.replace(/\D/g, '');
      if (wa.startsWith('0')) wa = '62' + wa.slice(1);
      else if (!wa.startsWith('62')) wa = '62' + wa; // fallback

      let total = cart.reduce((s, i) => s + i.qty * i.price, 0) + data.ship;
      const message = `üì¶ *Hallo Saya Mau Pesan, berikut pesanan saya*\n\n` +
        `*üë§ Nama:* *${data.name}*\n` +
        `*üì± WhatsApp:* *${wa}*\n` +
        `*üè† Alamat:* *${data.address}*\n` +
        (data.note ? `*üìù Catatan:* ${data.note}\n` : '') +
        `*üí≥ Pembayaran:* *${data.payment}*\n\n` +
        `üõí *Detail Pesanan*\n` +
        cart.map(i => `- ${i.name} x${i.qty} = ${formatRupiah(i.qty * i.price)}`).join('\n') +
        `\n\nüöö *Ongkir:* ${formatRupiah(data.ship)}\n` +
        `üí∞ *Total:* ${formatRupiah(total)}`;
      const whatsappLink = `https://api.whatsapp.com/send?phone=6281388728037&text=${encodeURIComponent(message)}`;
      window.open(whatsappLink, '_blank');

      // Close all modals & reset cart
      closeCheckoutForm(); closeReceiptPreview();
      document.getElementById('cart').classList.add('closed');
      document.getElementById('overlay').classList.add('hidden');
      cart = []; saveCart(); updateCart(); showToast('Pesanan dikirim ke WhatsApp ‚úÖ');
      window._checkoutData = null;
    }

    // ======= Testimoni =======
    function openTestiModal() { document.getElementById('testi-modal').classList.remove('hidden'); }
    function closeTestiModal() { document.getElementById('testi-modal').classList.add('hidden'); }

    function saveTesti(e) {
      e.preventDefault();
      const name = document.getElementById('testi-name').value.trim();
      const rating = Number(document.getElementById('testi-rating').value);
      const text = document.getElementById('testi-text').value.trim();
      if (!name || !text) { showToast('Nama & komentar wajib diisi', 'error'); return; }
      const list = JSON.parse(localStorage.getItem('testi') || '[]');
      list.unshift({ name, rating, text, time: new Date().toISOString() });
      localStorage.setItem('testi', JSON.stringify(list));
      renderTesti(); closeTestiModal(); showToast('Terima kasih atas testimoninya!');
      e.target.reset();
    }

    function renderTesti() {
      const list = JSON.parse(localStorage.getItem('testi') || '[]');
      const wrap = document.getElementById('testi-list');
      wrap.innerHTML = '';
      (list.length ? list : [
        { name: 'Rina', rating: 5, text: 'Pasta enak, pengiriman cepat!', time: new Date().toISOString() },
        { name: 'Bagas', rating: 4, text: 'Carbonara creamy banget.', time: new Date().toISOString() },
        { name: 'Sari', rating: 5, text: 'Harga ramah, rasa mewah.', time: new Date().toISOString() },
      ]).forEach(t => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl p-4 shadow';
        const stars = Array.from({ length: 5 }).map((_, i) => `<span class="${i < t.rating ? 'active' : ''} star">‚òÖ</span>`).join('');
        const date = new Date(t.time).toLocaleDateString('id-ID');
        card.innerHTML = `
          <div class="flex items-center justify-between mb-1">
            <strong>${t.name}</strong>
            <div class="text-yellow-500">${stars}</div>
          </div>
          <p class="text-sm text-gray-700">${t.text}</p>
          <p class="text-xs text-gray-400 mt-2">${date}</p>
        `;
        wrap.appendChild(card);
      });
    }

    // ======= Events =======
    document.getElementById('search').addEventListener('input', renderProducts);
    document.querySelectorAll('.tab').forEach(btn => btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('bg-green-600','text-white','active'));
      btn.classList.add('bg-green-600','text-white','active');
      currentCat = btn.dataset.cat; renderProducts();
    }));

    // close left menu when clicking outside (overlay already handles it)

    // ======= Init =======
    document.getElementById('year').textContent = new Date().getFullYear();
    renderProducts(); updateCart(); renderTesti();
  </script>
</body>
</html>
